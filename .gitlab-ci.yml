# =============================================================================
# BLAUWEISS-EDV LLC â€“ GitLab CI/CD Pipeline
# =============================================================================
#
# Baut PDFs aus LaTeX-Quellen und committet sie zurÃ¼ck ins Repo.
#
# =============================================================================

stages:
  - build

build-and-commit-pdfs:
  stage: build
  image: texlive/texlive:latest
  
  before_script:
    - apt-get update && apt-get install -y git
    - git config --global user.email "ci@blauweiss-edv.com"
    - git config --global user.name "GitLab CI"
  
  script:
    # Legal Formation Documents
    - echo "ðŸ“„ Building Legal Formation PDFs..."
    - cd legal/formation/src
    - |
      for texfile in *.tex; do
        if [ -f "$texfile" ]; then
          echo "   Building $texfile..."
          pdflatex -interaction=nonstopmode "$texfile" || true
          pdflatex -interaction=nonstopmode "$texfile" || true
        fi
      done
    - mv *.pdf ../dist/ 2>/dev/null || true
    - rm -f *.aux *.log *.out *.toc 2>/dev/null || true
    - cd ../../..
    
    # Invoice Templates
    - echo "ðŸ“„ Building Invoice Template PDFs..."
    - cd finance/templates/invoices/src
    - |
      for texfile in *.tex; do
        if [ -f "$texfile" ]; then
          echo "   Building $texfile..."
          pdflatex -interaction=nonstopmode "$texfile" || true
          pdflatex -interaction=nonstopmode "$texfile" || true
        fi
      done
    - mv *.pdf ../dist/ 2>/dev/null || true
    - rm -f *.aux *.log *.out *.toc 2>/dev/null || true
    - cd ../../../..
    
    - echo "âœ… PDF Build complete!"
    - find . -name "*.pdf" -type f
    
    # Commit zurÃ¼ck ins Repo
    - echo "ðŸ“¤ Committing PDFs to repo..."
    - git add "*.pdf"
    - |
      if git diff --staged --quiet; then
        echo "No changes to commit"
      else
        git commit -m "ðŸ¤– Auto-generate PDFs [skip ci]"
        git remote set-url origin "https://oauth2:${PROJECT_ACCESS_TOKEN}@gitlab.com/${CI_PROJECT_PATH}.git"
        git push origin HEAD:$CI_COMMIT_REF_NAME
        echo "âœ… PDFs committed!"
      fi

  rules:
    - if: $CI_COMMIT_MESSAGE =~ /\[skip ci\]/
      when: never
    - if: $CI_COMMIT_MESSAGE =~ /\[ci skip\]/
      when: never
    - if: $CI_PIPELINE_SOURCE == "push"
      changes:
        - "**/*.tex"
    - when: manual
      allow_failure: true
