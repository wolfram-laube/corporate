# =============================================================================
# BLAUWEISS-EDV LLC ‚Äì GitLab CI/CD Pipeline (Pandoc + Typst + Quarto)
# =============================================================================
#
# Generiert PDF, DOCX, HTML, TEX aus:
# - Markdown (.md) ‚Üí Pandoc
# - Typst (.typ) ‚Üí Typst
# - Quarto (.qmd) und Jupyter (.ipynb) ‚Üí Quarto
#
# Single Source of Truth: nur Quelldateien editieren!
#
# =============================================================================

stages:
  - build

# =============================================================================
# Job 1: Pandoc (Markdown ‚Üí PDF, DOCX, HTML, TEX)
# =============================================================================
build-pandoc-docs:
  stage: build
  image: ubuntu:22.04
  
  variables:
    DEBIAN_FRONTEND: noninteractive
    TZ: Europe/Vienna
  
  before_script:
    - apt-get update
    - apt-get install -y --no-install-recommends pandoc texlive-xetex texlive-fonts-recommended texlive-latex-recommended lmodern git ca-certificates
    - git config --global user.email "ci@blauweiss-edv.com"
    - git config --global user.name "GitLab CI"
    - git config --global --add safe.directory "$CI_PROJECT_DIR"
  
  script:
    - echo "üìÑ Building documents with Pandoc..."
    
    # Legal Formation Documents
    - |
      if [ -d "legal/formation/src" ]; then
        cd legal/formation/src
        for mdfile in *.md; do
          if [ -f "$mdfile" ]; then
            basename="${mdfile%.md}"
            echo "   Building $mdfile ‚Üí PDF, DOCX, HTML, TEX..."
            pandoc "$mdfile" -o "../dist/${basename}.pdf" --pdf-engine=xelatex -V geometry:margin=2.5cm || echo "   ‚ö†Ô∏è PDF failed for $mdfile"
            pandoc "$mdfile" -o "../dist/${basename}.docx" || echo "   ‚ö†Ô∏è DOCX failed for $mdfile"
            pandoc "$mdfile" -o "../dist/${basename}.html" --standalone || echo "   ‚ö†Ô∏è HTML failed for $mdfile"
            pandoc "$mdfile" -o "../dist/${basename}.tex" || echo "   ‚ö†Ô∏è TEX failed for $mdfile"
          fi
        done
        cd ../../..
      fi
    
    # Invoice Templates
    - |
      if [ -d "finance/templates/invoices/src" ]; then
        cd finance/templates/invoices/src
        for mdfile in *.md; do
          if [ -f "$mdfile" ]; then
            basename="${mdfile%.md}"
            echo "   Building $mdfile ‚Üí PDF, DOCX, HTML, TEX..."
            pandoc "$mdfile" -o "../dist/${basename}.pdf" --pdf-engine=xelatex -V geometry:margin=2.5cm || echo "   ‚ö†Ô∏è PDF failed for $mdfile"
            pandoc "$mdfile" -o "../dist/${basename}.docx" || echo "   ‚ö†Ô∏è DOCX failed for $mdfile"
            pandoc "$mdfile" -o "../dist/${basename}.html" --standalone || echo "   ‚ö†Ô∏è HTML failed for $mdfile"
            pandoc "$mdfile" -o "../dist/${basename}.tex" || echo "   ‚ö†Ô∏è TEX failed for $mdfile"
          fi
        done
        cd ../../../..
      fi
    
    # Compliance Checklist
    - |
      if [ -f "finance/compliance/04_LLC_Compliance_Checklist.md" ]; then
        cd finance/compliance
        pandoc "04_LLC_Compliance_Checklist.md" -o "04_LLC_Compliance_Checklist.pdf" --pdf-engine=xelatex -V geometry:margin=2.5cm || echo "   ‚ö†Ô∏è PDF failed"
        pandoc "04_LLC_Compliance_Checklist.md" -o "04_LLC_Compliance_Checklist.docx" || echo "   ‚ö†Ô∏è DOCX failed"
        pandoc "04_LLC_Compliance_Checklist.md" -o "04_LLC_Compliance_Checklist.html" --standalone || echo "   ‚ö†Ô∏è HTML failed"
        cd ../..
      fi
    
    - echo "‚úÖ Pandoc build complete!"
    
    # Commit
    - git add -A
    - |
      if git diff --staged --quiet; then
        echo "No Pandoc changes to commit"
      else
        git commit -m "ü§ñ Auto-generate documents from Markdown [skip ci]"
        git remote set-url origin "https://oauth2:${PROJECT_ACCESS_TOKEN}@gitlab.com/${CI_PROJECT_PATH}.git"
        git fetch origin $CI_COMMIT_REF_NAME
        git rebase origin/$CI_COMMIT_REF_NAME || true
        git push origin HEAD:$CI_COMMIT_REF_NAME
        echo "‚úÖ Pandoc documents committed!"
      fi

  rules:
    - if: $CI_COMMIT_MESSAGE =~ /\[skip ci\]/
      when: never
    - if: $CI_PIPELINE_SOURCE == "push"
      changes:
        - "**/*.md"
        - "!**/*.qmd"
    - when: manual
      allow_failure: true

# =============================================================================
# Job 2: Typst (.typ ‚Üí PDF)
# =============================================================================
build-typst-docs:
  stage: build
  image: ubuntu:22.04
  
  variables:
    DEBIAN_FRONTEND: noninteractive
    TZ: Europe/Vienna
  
  before_script:
    - apt-get update
    - apt-get install -y --no-install-recommends wget git ca-certificates xz-utils
    # Typst installieren
    - wget -qO- https://github.com/typst/typst/releases/latest/download/typst-x86_64-unknown-linux-musl.tar.xz | tar -xJf -
    - mv typst-x86_64-unknown-linux-musl/typst /usr/local/bin/
    - typst --version
    - git config --global user.email "ci@blauweiss-edv.com"
    - git config --global user.name "GitLab CI"
    - git config --global --add safe.directory "$CI_PROJECT_DIR"
  
  script:
    - echo "üìÑ Building documents with Typst..."
    
    # Alle .typ Dateien finden und kompilieren
    - |
      find . -name "*.typ" -type f | while read typfile; do
        dir=$(dirname "$typfile")
        base=$(basename "$typfile" .typ)
        echo "   Building $typfile ‚Üí PDF..."
        typst compile "$typfile" "${dir}/${base}.pdf" || echo "   ‚ö†Ô∏è Failed: $typfile"
      done
    
    - echo "‚úÖ Typst build complete!"
    - find . -name "*.pdf" -type f | head -20
    
    # Commit
    - git add -A
    - |
      if git diff --staged --quiet; then
        echo "No Typst changes to commit"
      else
        git commit -m "ü§ñ Auto-generate PDFs from Typst [skip ci]"
        git remote set-url origin "https://oauth2:${PROJECT_ACCESS_TOKEN}@gitlab.com/${CI_PROJECT_PATH}.git"
        git fetch origin $CI_COMMIT_REF_NAME
        git rebase origin/$CI_COMMIT_REF_NAME || true
        git push origin HEAD:$CI_COMMIT_REF_NAME
        echo "‚úÖ Typst documents committed!"
      fi

  rules:
    - if: $CI_COMMIT_MESSAGE =~ /\[skip ci\]/
      when: never
    - if: $CI_PIPELINE_SOURCE == "push"
      changes:
        - "**/*.typ"
    - when: manual
      allow_failure: true

# =============================================================================
# Job 3: Quarto (.qmd und .ipynb ‚Üí PDF, HTML, DOCX, TEX)
# =============================================================================
build-quarto-docs:
  stage: build
  image: ubuntu:22.04
  
  variables:
    DEBIAN_FRONTEND: noninteractive
    TZ: Europe/Vienna
  
  before_script:
    - apt-get update
    - apt-get install -y --no-install-recommends wget git ca-certificates xz-utils python3 python3-pip curl texlive-xetex texlive-fonts-recommended texlive-latex-recommended lmodern
    # Typst f√ºr Quarto PDF
    - wget -qO- https://github.com/typst/typst/releases/latest/download/typst-x86_64-unknown-linux-musl.tar.xz | tar -xJf -
    - mv typst-x86_64-unknown-linux-musl/typst /usr/local/bin/
    # Quarto installieren
    - wget -qO quarto.deb https://github.com/quarto-dev/quarto-cli/releases/download/v1.6.42/quarto-1.6.42-linux-amd64.deb
    - dpkg -i quarto.deb || apt-get install -f -y
    - quarto --version
    # Python-Pakete f√ºr Code-Ausf√ºhrung
    - pip3 install matplotlib numpy pandas jupyter nbformat
    - git config --global user.email "ci@blauweiss-edv.com"
    - git config --global user.name "GitLab CI"
    - git config --global --add safe.directory "$CI_PROJECT_DIR"
  
  script:
    - echo "üìÑ Building documents with Quarto..."
    
    # Alle .qmd Dateien rendern
    - |
      find . -name "*.qmd" -type f | while read qmdfile; do
        dir=$(dirname "$qmdfile")
        base=$(basename "$qmdfile" .qmd)
        echo "   Building $qmdfile ‚Üí PDF, HTML, DOCX, TEX..."
        quarto render "$qmdfile" --to typst --output "${base}.pdf" || echo "   ‚ö†Ô∏è PDF failed"
        quarto render "$qmdfile" --to html --output "${base}.html" || echo "   ‚ö†Ô∏è HTML failed"
        quarto render "$qmdfile" --to docx --output "${base}.docx" || echo "   ‚ö†Ô∏è DOCX failed"
        quarto render "$qmdfile" --to latex --output "${base}.tex" || echo "   ‚ö†Ô∏è TEX failed"
      done
    
    # Alle .ipynb Dateien rendern
    - |
      find . -name "*.ipynb" -type f | while read ipynbfile; do
        dir=$(dirname "$ipynbfile")
        base=$(basename "$ipynbfile" .ipynb)
        echo "   Building $ipynbfile ‚Üí PDF, HTML, DOCX, TEX..."
        quarto render "$ipynbfile" --to typst --output "${base}.pdf" || echo "   ‚ö†Ô∏è PDF failed"
        quarto render "$ipynbfile" --to html --output "${base}.html" || echo "   ‚ö†Ô∏è HTML failed"
        quarto render "$ipynbfile" --to docx --output "${base}.docx" || echo "   ‚ö†Ô∏è DOCX failed"
        quarto render "$ipynbfile" --to latex --output "${base}.tex" || echo "   ‚ö†Ô∏è TEX failed"
      done
    
    - echo "‚úÖ Quarto build complete!"
    - find . \( -name "*.pdf" -o -name "*.html" -o -name "*.docx" -o -name "*.tex" \) -type f | head -30
    
    # Commit
    - git add -A
    - |
      if git diff --staged --quiet; then
        echo "No Quarto changes to commit"
      else
        git commit -m "ü§ñ Auto-generate documents from Quarto/Jupyter [skip ci]"
        git remote set-url origin "https://oauth2:${PROJECT_ACCESS_TOKEN}@gitlab.com/${CI_PROJECT_PATH}.git"
        git fetch origin $CI_COMMIT_REF_NAME
        git rebase origin/$CI_COMMIT_REF_NAME || true
        git push origin HEAD:$CI_COMMIT_REF_NAME
        echo "‚úÖ Quarto documents committed!"
      fi

  rules:
    - if: $CI_COMMIT_MESSAGE =~ /\[skip ci\]/
      when: never
    - if: $CI_PIPELINE_SOURCE == "push"
      changes:
        - "**/*.qmd"
        - "**/*.ipynb"
    - when: manual
      allow_failure: true
