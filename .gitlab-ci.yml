# =============================================================================
# BLAUWEISS-EDV LLC ‚Äì GitLab CI/CD Pipeline (Pandoc + Typst + Quarto)
# =============================================================================
#
# FIXED: dependencies statt needs f√ºr zuverl√§ssige Artifact-√úbergabe
#
# =============================================================================

stages:
  - build
  - commit
  - upload

# =============================================================================
# Job 1: Pandoc (Markdown ‚Üí PDF, DOCX, HTML, TEX)
# =============================================================================
build-pandoc-docs:
  stage: build
  image: ubuntu:22.04
  tags:
    - docker-any
  
  variables:
    DEBIAN_FRONTEND: noninteractive
    TZ: Europe/Vienna
  
  before_script:
    - apt-get update
    - apt-get install -y --no-install-recommends pandoc texlive-xetex texlive-fonts-recommended texlive-latex-recommended lmodern git ca-certificates
  
  script:
    - echo "üìÑ Building documents with Pandoc..."
    - mkdir -p generated/legal generated/finance
    
    # Legal Formation Documents
    - |
      if [ -d "legal/formation/src" ]; then
        cd legal/formation/src
        for mdfile in *.md; do
          if [ -f "$mdfile" ]; then
            basename="${mdfile%.md}"
            echo "   Building $mdfile..."
            pandoc "$mdfile" -o "../dist/${basename}.pdf" --pdf-engine=xelatex -V geometry:margin=2.5cm || true
            pandoc "$mdfile" -o "../dist/${basename}.docx" || true
          fi
        done
        cd ../../..
        cp -r legal/formation/dist/* generated/legal/ 2>/dev/null || true
      fi
    
    # Invoice Templates
    - |
      if [ -d "finance/templates/invoices/src" ]; then
        cd finance/templates/invoices/src
        for mdfile in *.md; do
          if [ -f "$mdfile" ]; then
            basename="${mdfile%.md}"
            echo "   Building $mdfile..."
            pandoc "$mdfile" -o "../dist/${basename}.pdf" --pdf-engine=xelatex -V geometry:margin=2.5cm || true
            pandoc "$mdfile" -o "../dist/${basename}.docx" || true
          fi
        done
        cd ../../../..
        cp -r finance/templates/invoices/dist/* generated/finance/ 2>/dev/null || true
      fi
    
    - echo "‚úÖ Pandoc build complete!"
    - ls -la generated/ 2>/dev/null || true

  artifacts:
    paths:
      - generated/
      - legal/formation/dist/
      - finance/templates/invoices/dist/
      - finance/compliance/
    expire_in: 1 hour

  rules:
    - if: $CI_COMMIT_MESSAGE =~ /\[skip ci\]/
      when: never
    - if: $CI_PIPELINE_SOURCE == "push"
      changes:
        - "**/*.md"
        - "!**/*.qmd"
    - when: manual
      allow_failure: true

# =============================================================================
# Job 2: Typst (.typ ‚Üí PDF)
# =============================================================================
build-typst-docs:
  stage: build
  image: ubuntu:22.04
  tags:
    - docker-any
  
  variables:
    DEBIAN_FRONTEND: noninteractive
    TZ: Europe/Vienna
  
  before_script:
    - apt-get update
    - apt-get install -y --no-install-recommends wget ca-certificates xz-utils
    - wget -qO- https://github.com/typst/typst/releases/latest/download/typst-x86_64-unknown-linux-musl.tar.xz | tar -xJf -
    - mv typst-x86_64-unknown-linux-musl/typst /usr/local/bin/
    - typst --version
  
  script:
    - echo "üìÑ Building documents with Typst..."
    - mkdir -p generated/typst-invoices
    
    - |
      find . -name "*.typ" -type f | while read typfile; do
        dir=$(dirname "$typfile")
        base=$(basename "$typfile" .typ)
        echo "   Building $typfile ‚Üí PDF..."
        typst compile --font-path "$dir" "$typfile" "${dir}/${base}.pdf" || echo "   ‚ö†Ô∏è Failed: $typfile"
      done
    
    # Kopiere ALLE generierten Invoice PDFs in den generated Ordner
    - echo "=== Copying Invoice PDFs to generated/ ==="
    - cp -v finance/templates/invoices/typst/*.pdf generated/typst-invoices/ 2>/dev/null || true
    
    - echo "=== Generated Typst PDFs ==="
    - ls -la generated/typst-invoices/
    - ls -la finance/templates/invoices/typst/*.pdf 2>/dev/null || echo "Keine Invoice PDFs"
    
    - echo "‚úÖ Typst build complete!"

  artifacts:
    paths:
      - generated/
      - finance/templates/invoices/typst/*.pdf
      - experimental/typst/*.pdf
    expire_in: 1 hour

  rules:
    - if: $CI_COMMIT_MESSAGE =~ /\[skip ci\]/
      when: never
    - if: $CI_PIPELINE_SOURCE == "push"
      changes:
        - "**/*.typ"
    - when: manual
      allow_failure: true

# =============================================================================
# Job 3: Quarto (.qmd und .ipynb ‚Üí PDF, HTML, DOCX, TEX)
# =============================================================================
build-quarto-docs:
  stage: build
  image: ubuntu:22.04
  tags:
    - docker-any
  
  variables:
    DEBIAN_FRONTEND: noninteractive
    TZ: Europe/Vienna
  
  before_script:
    - apt-get update
    - apt-get install -y --no-install-recommends wget ca-certificates xz-utils python3 python3-pip curl texlive-xetex texlive-fonts-recommended texlive-latex-recommended lmodern
    - wget -qO- https://github.com/typst/typst/releases/latest/download/typst-x86_64-unknown-linux-musl.tar.xz | tar -xJf -
    - mv typst-x86_64-unknown-linux-musl/typst /usr/local/bin/
    - wget -qO quarto.deb https://github.com/quarto-dev/quarto-cli/releases/download/v1.6.42/quarto-1.6.42-linux-amd64.deb
    - dpkg -i quarto.deb || apt-get install -f -y
    - quarto --version
    - pip3 install matplotlib numpy pandas jupyter nbformat
  
  script:
    - echo "üìÑ Building documents with Quarto..."
    - mkdir -p generated/quarto
    
    - |
      find . -name "*.qmd" -type f | while read qmdfile; do
        dir=$(dirname "$qmdfile")
        filename=$(basename "$qmdfile")
        base=$(basename "$qmdfile" .qmd)
        echo "   Building $qmdfile..."
        (cd "$dir" && quarto render "$filename" --to typst --output "${base}.pdf") || true
        (cd "$dir" && quarto render "$filename" --to docx --output "${base}.docx") || true
      done
    
    - |
      find . -name "*.ipynb" -type f | while read ipynbfile; do
        dir=$(dirname "$ipynbfile")
        filename=$(basename "$ipynbfile")
        base=$(basename "$ipynbfile" .ipynb)
        echo "   Building $ipynbfile..."
        (cd "$dir" && quarto render "$filename" --to typst --output "${base}.pdf") || true
        (cd "$dir" && quarto render "$filename" --to docx --output "${base}.docx") || true
      done
    
    - echo "‚úÖ Quarto build complete!"

  artifacts:
    paths:
      - generated/
      - "**/*.pdf"
      - "**/*.docx"
    expire_in: 1 hour

  rules:
    - if: $CI_COMMIT_MESSAGE =~ /\[skip ci\]/
      when: never
    - if: $CI_PIPELINE_SOURCE == "push"
      changes:
        - "**/*.qmd"
        - "**/*.ipynb"
    - when: manual
      allow_failure: true

# =============================================================================
# Job 4: Commit & Push
# =============================================================================
commit-all:
  stage: commit
  image: ubuntu:22.04
  tags:
    - docker-any
  
  variables:
    DEBIAN_FRONTEND: noninteractive
    TZ: Europe/Vienna
  
  # WICHTIG: dependencies statt needs f√ºr zuverl√§ssige Artifact-√úbergabe
  dependencies:
    - build-pandoc-docs
    - build-typst-docs
    - build-quarto-docs
  
  before_script:
    - apt-get update
    - apt-get install -y --no-install-recommends git ca-certificates git-lfs
    - git lfs install --force
    - git config --global user.email "ci@blauweiss-edv.com"
    - git config --global user.name "GitLab CI"
    - git config --global --add safe.directory "$CI_PROJECT_DIR"
  
  script:
    - echo "üì¶ Committing all generated documents..."
    
    # DEBUG: Was haben wir von den Build-Jobs?
    - echo "=== Artifacts von Build-Jobs ==="
    - ls -la generated/ 2>/dev/null || echo "Kein generated/ Ordner"
    - ls -la generated/typst-invoices/ 2>/dev/null || echo "Keine typst-invoices"
    - echo ""
    - echo "=== Alle PDFs im Arbeitsverzeichnis ==="
    - find . -name "*.pdf" -type f | head -30
    - echo ""
    - echo "=== Speziell Typst-Invoices ==="
    - ls -la finance/templates/invoices/typst/*.pdf 2>/dev/null || echo "‚ö†Ô∏è Keine Invoice PDFs!"
    
    # Kopiere generierte Dateien zur√ºck an die richtigen Stellen
    - echo "=== Restoring generated files ==="
    - cp -v generated/typst-invoices/*.pdf finance/templates/invoices/typst/ 2>/dev/null || echo "‚ÑπÔ∏è No typst-invoices to restore"
    - cp -v generated/legal/*.pdf legal/formation/dist/ 2>/dev/null || true
    - cp -v generated/finance/*.pdf finance/templates/invoices/dist/ 2>/dev/null || true
    
    # Nochmal checken
    - echo "=== Nach Restore ==="
    - ls -la finance/templates/invoices/typst/*.pdf 2>/dev/null || echo "‚ö†Ô∏è Immer noch keine Invoice PDFs!"
    
    # Git f√ºr Push konfigurieren
    - git remote set-url origin "https://oauth2:${PROJECT_ACCESS_TOKEN}@gitlab.com/${CI_PROJECT_PATH}.git"
    
    - echo "=== Git Status ==="
    - git status --short | head -30
    
    - git add -A
    - |
      if git diff --staged --quiet; then
        echo "‚úÖ No changes to commit"
      else
        echo "=== Staged changes ==="
        git diff --staged --name-only | head -20
        git commit -m "ü§ñ Auto-generate documents [skip ci]"
        git push origin HEAD:$CI_COMMIT_REF_NAME
        echo "‚úÖ All documents committed and pushed!"
      fi

  rules:
    - if: $CI_COMMIT_MESSAGE =~ /\[skip ci\]/
      when: never
    - when: always

# =============================================================================
# Job 5: Upload to Google Drive
# =============================================================================
upload-to-gdrive:
  stage: upload
  image: ubuntu:22.04
  tags:
    - docker-any
  
  variables:
    DEBIAN_FRONTEND: noninteractive
    TZ: Europe/Vienna
  
  # WICHTIG: dependencies f√ºr Artifact-√úbergabe
  dependencies:
    - build-pandoc-docs
    - build-typst-docs
    - build-quarto-docs
  
  before_script:
    - apt-get update
    - apt-get install -y --no-install-recommends curl unzip ca-certificates
    - curl -O https://downloads.rclone.org/rclone-current-linux-amd64.zip
    - unzip rclone-current-linux-amd64.zip
    - cp rclone-*-linux-amd64/rclone /usr/local/bin/
    - rclone --version
  
  script:
    - echo "üì§ Uploading documents to Google Drive..."
    
    # DEBUG: Was haben wir?
    - echo "=== Artifacts von Build-Jobs ==="
    - ls -la generated/ 2>/dev/null || echo "Kein generated/ Ordner"
    - ls -la generated/typst-invoices/ 2>/dev/null || echo "Keine typst-invoices"
    - echo ""
    - echo "=== Speziell Typst-Invoices (aus generated/) ==="
    - ls -la generated/typst-invoices/*.pdf 2>/dev/null || echo "‚ö†Ô∏è Keine Invoice PDFs in generated!"
    
    # Upload aus generated/typst-invoices (die sauberen Artifacts)
    - |
      if [ -d "generated/typst-invoices" ]; then
        for file in generated/typst-invoices/*.pdf; do
          if [ -f "$file" ]; then
            echo "   Uploading $file..."
            rclone --config $RCLONE_CONF copy "$file" "gdrive:/BLAUWEISS-EDV-LLC/generated/" || echo "   ‚ö†Ô∏è Failed: $file"
          fi
        done
      fi
    
    # Upload alle anderen PDFs
    - |
      find . -path ./generated -prune -o -name "*.pdf" -type f -print | while read file; do
        echo "   Uploading $file..."
        rclone --config $RCLONE_CONF copy "$file" "gdrive:/BLAUWEISS-EDV-LLC/generated/" || echo "   ‚ö†Ô∏è Failed: $file"
      done
    
    # Upload alle DOCX
    - |
      find . -name "*.docx" -type f | while read file; do
        echo "   Uploading $file..."
        rclone --config $RCLONE_CONF copy "$file" "gdrive:/BLAUWEISS-EDV-LLC/generated/" || echo "   ‚ö†Ô∏è Failed: $file"
      done
    
    - echo "‚úÖ Upload complete!"

  rules:
    - if: $CI_COMMIT_MESSAGE =~ /\[skip ci\]/
      when: never
    - when: always
