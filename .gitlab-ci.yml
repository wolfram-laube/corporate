# =============================================================================
# BLAUWEISS-EDV LLC â€“ GitLab CI/CD Pipeline (Pandoc)
# =============================================================================
#
# Generiert PDF, DOCX, HTML aus Markdown-Quellen
# Single Source of Truth: nur .md editieren!
#
# =============================================================================

stages:
  - build

build-and-commit-docs:
  stage: build
  image: pandoc/extra:latest
  
  before_script:
    - apk add --no-cache git
    - git config --global user.email "ci@blauweiss-edv.com"
    - git config --global user.name "GitLab CI"
  
  script:
    # Legal Formation Documents
    - echo "ðŸ“„ Building Legal Formation Documents..."
    - cd legal/formation/src
    - |
      for mdfile in *.md; do
        if [ -f "$mdfile" ]; then
          basename="${mdfile%.md}"
          echo "   Building $mdfile â†’ PDF, DOCX, HTML..."
          pandoc "$mdfile" -o "../dist/${basename}.pdf" --pdf-engine=xelatex -V geometry:margin=2.5cm -V mainfont="DejaVu Sans" || true
          pandoc "$mdfile" -o "../dist/${basename}.docx" || true
          pandoc "$mdfile" -o "../dist/${basename}.html" --standalone --metadata title="${basename}" || true
        fi
      done
    - cd ../../..
    
    # Invoice Templates
    - echo "ðŸ“„ Building Invoice Templates..."
    - cd finance/templates/invoices/src
    - |
      for mdfile in *.md; do
        if [ -f "$mdfile" ]; then
          basename="${mdfile%.md}"
          echo "   Building $mdfile â†’ PDF, DOCX, HTML..."
          pandoc "$mdfile" -o "../dist/${basename}.pdf" --pdf-engine=xelatex -V geometry:margin=2.5cm -V mainfont="DejaVu Sans" || true
          pandoc "$mdfile" -o "../dist/${basename}.docx" || true
          pandoc "$mdfile" -o "../dist/${basename}.html" --standalone --metadata title="${basename}" || true
        fi
      done
    - cd ../../../..
    
    - echo "âœ… Document Build complete!"
    - echo "Generated files:"
    - find . -path ./node_modules -prune -o \( -name "*.pdf" -o -name "*.docx" -o -name "*.html" \) -type f -print
    
    # Commit zurÃ¼ck ins Repo
    - echo "ðŸ“¤ Committing generated documents to repo..."
    - git add -A
    - |
      if git diff --staged --quiet; then
        echo "No changes to commit"
      else
        git commit -m "ðŸ¤– Auto-generate documents from Markdown [skip ci]"
        git remote set-url origin "https://oauth2:${PROJECT_ACCESS_TOKEN}@gitlab.com/${CI_PROJECT_PATH}.git"
        git fetch origin $CI_COMMIT_REF_NAME
        git rebase origin/$CI_COMMIT_REF_NAME || true
        git push origin HEAD:$CI_COMMIT_REF_NAME
        echo "âœ… Documents committed!"
      fi

  rules:
    - if: $CI_COMMIT_MESSAGE =~ /\[skip ci\]/
      when: never
    - if: $CI_COMMIT_MESSAGE =~ /\[ci skip\]/
      when: never
    - if: $CI_PIPELINE_SOURCE == "push"
      changes:
        - "**/*.md"
    - when: manual
      allow_failure: true
